# ğŸš€ Stock Optimization: Phase 3 & 4 Implementation Plan

## Má»¥c tiÃªu
Tá»‘i Æ°u hÃ³a flow order Ä‘á»ƒ Ä‘áº¡t throughput cao (50k+ req/s) vÃ  loáº¡i bá» race condition trong há»‡ thá»‘ng microservice.

---

# ğŸ“– PHASE 3: PRE-RESERVE PATTERN

## LÃ½ thuyáº¿t cÆ¡ báº£n

### Váº¥n Ä‘á» hiá»‡n táº¡i: "Check-Then-Act" Anti-Pattern

Flow hiá»‡n táº¡i cÃ³ má»™t lá»— há»•ng nghiÃªm trá»ng gá»i lÃ  **TOCTOU (Time-of-Check to Time-of-Use)**:

```
                    TIMELINE
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶
    
    User A                              User B
    â”€â”€â”€â”€â”€â”€                              â”€â”€â”€â”€â”€â”€
    â”‚                                   â”‚
    â”‚ â‘  CHECK: stock = 5                â”‚
    â”‚      â†“                            â”‚ â‘  CHECK: stock = 5
    â”‚ â‘¡ 5 >= 3? âœ“ OK                    â”‚      â†“
    â”‚      â†“                            â”‚ â‘¡ 5 >= 3? âœ“ OK
    â”‚      â†“    â—€â”€â”€â”€ RACE WINDOW â”€â”€â”€â–¶   â”‚      â†“
    â”‚ â‘¢ UPDATE: stock = 2               â”‚      â†“
    â”‚                                   â”‚ â‘¢ UPDATE: stock = 2
    â”‚                                   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    
    Káº¿t quáº£: Cáº£ 2 orders Ä‘á»u thÃ nh cÃ´ng!
    Stock cuá»‘i: 2 (nhÆ°ng Ä‘Ã¡ng láº½: 5 - 3 - 3 = -1)
    â†’ OVERSELL: BÃ¡n quÃ¡ sá»‘ lÆ°á»£ng tá»“n kho!
```

### Giáº£i phÃ¡p: Reserve-Confirm-Cancel Pattern

MÃ´ hÃ¬nh nÃ y láº¥y cáº£m há»©ng tá»« há»‡ thá»‘ng Ä‘áº·t vÃ© mÃ¡y bay/khÃ¡ch sáº¡n:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         RESERVATION LIFECYCLE                                â”‚
â”‚                                                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚   â”‚ AVAILABLEâ”‚â”€â”€â”€â”€â–¶â”‚ RESERVED â”‚â”€â”€â”€â”€â–¶â”‚ CONFIRMEDâ”‚     â”‚ CANCELLEDâ”‚          â”‚
â”‚   â”‚          â”‚     â”‚ (Pending)â”‚     â”‚ (Sold)   â”‚     â”‚ (Restored)           â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚        â”‚                â”‚                â”‚                â–²                 â”‚
â”‚        â”‚                â”‚                â”‚                â”‚                 â”‚
â”‚        â”‚                â”‚                â”‚                â”‚                 â”‚
â”‚        â”‚           â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚        â”‚           â”‚                                                        â”‚
â”‚        â”‚           â”‚  TIMEOUT (15 min) hoáº·c PAYMENT_FAILED                 â”‚
â”‚        â”‚           â”‚  â†’ Tá»± Ä‘á»™ng rollback stock                             â”‚
â”‚        â”‚           â”‚                                                        â”‚
â”‚        â”‚           â–¼                                                        â”‚
â”‚        â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚        â”‚    â”‚  ROLLBACK: INCRBY stock +quantity               â”‚            â”‚
â”‚        â”‚    â”‚  â†’ Stock trá»Ÿ vá» Available                        â”‚            â”‚
â”‚        â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚        â”‚                                                                    â”‚
â”‚        â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚        â””â”€â–¶â”‚  RESERVE: DECRBY stock -quantity                    â”‚          â”‚
â”‚           â”‚  + SET reservation_key vá»›i TTL                      â”‚          â”‚
â”‚           â”‚  â†’ Stock chuyá»ƒn sang Reserved                        â”‚          â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Táº¡i sao pattern nÃ y hoáº¡t Ä‘á»™ng?

**1. Atomic Reservation (Lua Script)**
```lua
-- ÄÃ¢y lÃ  má»™t operation DUY NHáº¤T, khÃ´ng thá»ƒ bá»‹ interrupt
local stock = redis.call('GET', KEYS[1])        -- Äá»c
if tonumber(stock) >= tonumber(ARGV[1]) then    -- Check
    redis.call('DECRBY', KEYS[1], ARGV[1])      -- Update
    redis.call('SETEX', KEYS[2], 900, ARGV[1])  -- Ghi reserve key
    return 1
end
return 0
```

Lua script trong Redis lÃ  **ATOMIC** vÃ¬ Redis lÃ  **single-threaded**. Trong khi script Ä‘ang cháº¡y, khÃ´ng cÃ³ command nÃ o khÃ¡c cÃ³ thá»ƒ chen vÃ o.

**2. Fail-Fast Response**
- User biáº¿t NGAY Láº¬P Tá»¨C náº¿u háº¿t hÃ ng (trong 5ms thay vÃ¬ 200ms)
- KhÃ´ng cáº§n Ä‘á»£i Kafka consumer xá»­ lÃ½

**3. Automatic Cleanup**
- Reserve key cÃ³ TTL 15 phÃºt
- Náº¿u payment khÃ´ng hoÃ n thÃ nh â†’ Stock tá»± Ä‘á»™ng rollback
- KhÃ´ng bao giá» "káº¹t" stock

---

## Redis Data Model

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           REDIS KEYS STRUCTURE                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  STOCK KEYS (Permanent)                                                     â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                                                    â”‚
â”‚  stock:product123:size-m    â†’  INTEGER  â†’  "50"                            â”‚
â”‚  stock:product123:size-l    â†’  INTEGER  â†’  "30"                            â”‚
â”‚  stock:product456:size-s    â†’  INTEGER  â†’  "100"                           â”‚
â”‚                                                                              â”‚
â”‚  RESERVATION KEYS (TTL = 15 minutes)                                        â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                                         â”‚
â”‚  reserve:order789:product123:size-m  â†’  INTEGER  â†’  "3"   TTL: 900s       â”‚
â”‚       â†³ OrderID   â†³ ProductID  â†³ SizeID    â†³ Quantity         â”‚
â”‚                                                                              â”‚
â”‚  reserve:order790:product123:size-m  â†’  INTEGER  â†’  "2"   TTL: 850s       â”‚
â”‚  reserve:order791:product456:size-s  â†’  INTEGER  â†’  "5"   TTL: 870s       â”‚
â”‚                                                                              â”‚
â”‚                                                                              â”‚
â”‚  TÃNH TOÃN                                                                  â”‚
â”‚  â•â•â•â•â•â•â•â•â•                                                                  â”‚
â”‚  Available Stock = stock:xxx - SUM(reserve:*:xxx)                          â”‚
â”‚                                                                              â”‚
â”‚  VÃ­ dá»¥: product123:size-m                                                  â”‚
â”‚  - Redis stock key: 50                                                      â”‚
â”‚  - Reserve order789: 3                                                      â”‚
â”‚  - Reserve order790: 2                                                      â”‚
â”‚  â†’ Available = 50 (stock Ä‘Ã£ trá»« sáºµn khi reserve)                          â”‚
â”‚  â†’ Náº¿u order789 cancelled â†’ stock = 50 + 3 = 53                           â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Sequence Diagram: Complete Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Client â”‚     â”‚OrderServiceâ”‚     â”‚  Redis  â”‚     â”‚  Kafka  â”‚     â”‚StockConsumerâ”‚
â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
    â”‚                â”‚                  â”‚               â”‚                 â”‚
    â”‚ POST /checkout â”‚                  â”‚               â”‚                 â”‚
    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                  â”‚               â”‚                 â”‚
    â”‚                â”‚                  â”‚               â”‚                 â”‚
    â”‚                â”‚ EVAL reserve.lua â”‚               â”‚                 â”‚
    â”‚                â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚               â”‚                 â”‚
    â”‚                â”‚                  â”‚               â”‚                 â”‚
    â”‚                â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚                 â”‚
    â”‚                â”‚   â”‚ Lua Script (ATOMIC):        â”‚â”‚                 â”‚
    â”‚                â”‚   â”‚ 1. GET stock:prod:size      â”‚â”‚                 â”‚
    â”‚                â”‚   â”‚ 2. CHECK >= quantity        â”‚â”‚                 â”‚
    â”‚                â”‚   â”‚ 3. DECRBY stock             â”‚â”‚                 â”‚
    â”‚                â”‚   â”‚ 4. SETEX reserve:order:...  â”‚â”‚                 â”‚
    â”‚                â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚                 â”‚
    â”‚                â”‚                  â”‚               â”‚                 â”‚
    â”‚                â”‚  result: 1 (OK)  â”‚               â”‚                 â”‚
    â”‚                â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚               â”‚                 â”‚
    â”‚                â”‚                  â”‚               â”‚                 â”‚
    â”‚                â”‚ Publish OrderEvent               â”‚                 â”‚
    â”‚                â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                 â”‚
    â”‚                â”‚                  â”‚               â”‚                 â”‚
    â”‚ 202 Accepted   â”‚                  â”‚               â”‚                 â”‚
    â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                  â”‚               â”‚                 â”‚
    â”‚ (orderId: xxx) â”‚                  â”‚               â”‚                 â”‚
    â”‚                â”‚                  â”‚               â”‚                 â”‚
    â”‚                â”‚                  â”‚               â”‚ Consume Event   â”‚
    â”‚                â”‚                  â”‚               â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
    â”‚                â”‚                  â”‚               â”‚                 â”‚
    â”‚                â”‚                  â”‚               â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                â”‚                  â”‚               â”‚   â”‚ 1. Save Order to DB       â”‚
    â”‚                â”‚                  â”‚               â”‚   â”‚ 2. Sync stock to DB       â”‚
    â”‚                â”‚                  â”‚               â”‚   â”‚ 3. Delete reserve key     â”‚
    â”‚                â”‚                  â”‚               â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚                â”‚                  â”‚               â”‚                 â”‚
    â”‚                â”‚                  â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
    â”‚                â”‚                  â”‚  DEL reserve:order:...          â”‚
    â”‚                â”‚                  â”‚               â”‚                 â”‚
    â–¼                â–¼                  â–¼               â–¼                 â–¼

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                            NHÃNH: PAYMENT TIMEOUT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ScheduledJobâ”‚                         â”‚  Redis  â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                         â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
      â”‚                                     â”‚
      â”‚ (Every 1 minute)                    â”‚
      â”‚ SCAN reserve:*                      â”‚
      â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
      â”‚                                     â”‚
      â”‚ Found expired keys (TTL = 0)        â”‚
      â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
      â”‚                                     â”‚
      â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚   â”‚  FOR EACH expired reserve key:                                  â”‚
      â”‚   â”‚  1. Parse: orderId, productId, sizeId, quantity                â”‚
      â”‚   â”‚  2. INCRBY stock:{productId}:{sizeId} {quantity}  â† ROLLBACK   â”‚
      â”‚   â”‚  3. Update Order status = EXPIRED                              â”‚
      â”‚   â”‚  4. DEL reserve key                                            â”‚
      â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚                                     â”‚
      â–¼                                     â–¼
```

---

## Files sáº½ thay Ä‘á»•i

### Stock Service

| File | Action | MÃ´ táº£ |
|------|--------|-------|
| [NEW] `StockReservationService.java` | Táº¡o má»›i | Service xá»­ lÃ½ reserve/confirm/cancel |
| [NEW] `ReservationCleanupJob.java` | Táº¡o má»›i | Scheduled job cleanup expired |
| [MODIFY] `StockCacheService.java` | Sá»­a | ThÃªm method reserve vá»›i Lua |
| [MODIFY] `RedisConfig.java` | Sá»­a | ThÃªm Lua script beans |

### Order Service

| File | Action | MÃ´ táº£ |
|------|--------|-------|
| [MODIFY] `OrderServiceImpl.java` | Sá»­a | Gá»i reserve trÆ°á»›c khi publish Kafka |
| [MODIFY] `CheckOutKafkaRequest.java` | Sá»­a | ThÃªm field tempOrderId |
| [NEW] `StockReservationClient.java` | Táº¡o má»›i | Feign client gá»i stock-service |

---

# ğŸ“– PHASE 4: FLASH SALE OPTIMIZATION

## LÃ½ thuyáº¿t: Thundering Herd Problem

### Äá»‹nh nghÄ©a

**Thundering Herd** lÃ  hiá»‡n tÆ°á»£ng hÃ ng ngÃ n/triá»‡u requests Ä‘á»• dá»“n vÃ o há»‡ thá»‘ng cÃ¹ng má»™t lÃºc, nhÆ° má»™t Ä‘Ã n voi giáº«m Ä‘áº¡p (stampede).

```
                    FLASH SALE: 9:00:00 AM
                    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    
            TrÆ°á»›c 9:00              ÄÃºng 9:00:00
            â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€              â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                                    
    User A â—‹â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ âš¡ â”€â”
    User B â—‹â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ âš¡ â”€â”¤
    User C â—‹â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ âš¡ â”€â”¤
    User D â—‹â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ âš¡ â”€â”¼â”€â”€â”€â–¶ SERVER CRASH! ğŸ’¥
    ...                              ...  â”‚
    User N â—‹â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ âš¡ â”€â”˜
         (10,000 users)            (10,000 requests/second)
         
         
    Háº­u quáº£:
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ âŒ Database connection pool exhausted                      â”‚
    â”‚ âŒ Redis maxmemory exceeded                                â”‚
    â”‚ âŒ Kafka consumer lag spike                                â”‚
    â”‚ âŒ JVM heap OOM (Out of Memory)                           â”‚
    â”‚ âŒ Network timeout â†’ All requests fail                     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Giáº£i phÃ¡p tá»•ng thá»ƒ: Multi-Layer Defense

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        FLASH SALE DEFENSE LAYERS                            â”‚
â”‚                                                                              â”‚
â”‚   LAYER 1: RATE LIMITING (Giá»›i háº¡n request/giÃ¢y)                           â”‚
â”‚   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                              â”‚
â”‚   â”‚                                                                         â”‚
â”‚   â”‚  10,000 req â”€â”€â–¶ [Rate Limiter: 2000/s] â”€â”€â–¶ 2,000 req (8,000 rejected) â”‚
â”‚   â”‚                                                                         â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚                                                                              â”‚
â”‚   LAYER 2: PER-USER LIMIT (Má»—i user chá»‰ mua N sáº£n pháº©m)                    â”‚
â”‚   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                       â”‚
â”‚   â”‚                                                                         â”‚
â”‚   â”‚  User A: Ä‘Ã£ mua 2/2 items â”€â”€â–¶ REJECTED                                â”‚
â”‚   â”‚  User B: Ä‘Ã£ mua 1/2 items â”€â”€â–¶ ALLOWED (can buy 1 more)               â”‚
â”‚   â”‚                                                                         â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚                                                                              â”‚
â”‚   LAYER 3: QUEUE-BASED ORDERING (FIFO - First In First Out)               â”‚
â”‚   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                   â”‚
â”‚   â”‚                                                                         â”‚
â”‚   â”‚  Request 1 (9:00:00.001) â”€â”€â”                                           â”‚
â”‚   â”‚  Request 2 (9:00:00.002) â”€â”€â”¼â”€â”€â–¶ [Queue] â”€â”€â–¶ Process in ORDER          â”‚
â”‚   â”‚  Request 3 (9:00:00.003) â”€â”€â”˜                                           â”‚
â”‚   â”‚                                                                         â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚                                                                              â”‚
â”‚   LAYER 4: SEPARATE FLASH STOCK (Stock riÃªng cho Flash Sale)              â”‚
â”‚   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•              â”‚
â”‚   â”‚                                                                         â”‚
â”‚   â”‚  Regular Stock: 1000 â”€â”€â–¶ KhÃ´ng bá»‹ áº£nh hÆ°á»Ÿng                           â”‚
â”‚   â”‚  Flash Stock: 100    â”€â”€â–¶ Chá»‰ dÃ¹ng cho flash sale                      â”‚
â”‚   â”‚                                                                         â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Layer 1: Rate Limiting vá»›i Token Bucket

### Giáº£i thÃ­ch Token Bucket Algorithm

TÆ°á»Ÿng tÆ°á»£ng má»™t cÃ¡i xÃ´ (bucket) chá»©a cÃ¡c Ä‘á»“ng xu (token):
- **Refill**: Má»—i giÃ¢y, xÃ´ Ä‘Æ°á»£c Ä‘á»• thÃªm N token (vÃ­ dá»¥: 2000 token/s)
- **Request**: Má»—i request "láº¥y" 1 token tá»« xÃ´
- **Empty**: Náº¿u xÃ´ háº¿t token â†’ Request bá»‹ tá»« chá»‘i

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         TOKEN BUCKET VISUALIZATION                           â”‚
â”‚                                                                              â”‚
â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚            â”‚  â˜â˜â˜â˜â˜â˜â˜â˜â˜â˜â˜â˜â˜â˜â˜â˜â˜â˜â˜â˜  BUCKET          â”‚                      â”‚
â”‚            â”‚  â˜‘â˜‘â˜‘â˜‘â˜‘â˜‘â˜‘â˜‘â˜‘â˜‘â˜‘â˜‘â˜‘â˜‘â˜‘â˜‘â˜‘â˜‘â˜‘â˜‘  (capacity=2000) â”‚                      â”‚
â”‚            â”‚  â˜‘â˜‘â˜‘â˜‘â˜‘â˜‘â˜‘â˜‘â˜‘â˜‘â˜‘â˜‘â˜‘â˜‘â˜‘â˜‘â˜‘â˜‘â˜‘â˜‘                  â”‚                      â”‚
â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚                           â”‚                                                  â”‚
â”‚   REFILL                 â–¼                   CONSUME                        â”‚
â”‚   â•â•â•â•â•â•          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â•â•â•â•â•â•â•                        â”‚
â”‚                   â”‚  Tokens:    â”‚                                           â”‚
â”‚   +2000/s â”€â”€â”€â”€â”€â”€â”€â–¶â”‚    1850     â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -150 (150 requests)          â”‚
â”‚   (Every second)  â”‚             â”‚                                           â”‚
â”‚                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                           â”‚
â”‚                                                                              â”‚
â”‚                                                                              â”‚
â”‚   TIMELINE EXAMPLE:                                                         â”‚
â”‚   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                                                        â”‚
â”‚                                                                              â”‚
â”‚   Time    Tokens    Requests    Result                                      â”‚
â”‚   â”€â”€â”€â”€    â”€â”€â”€â”€â”€â”€    â”€â”€â”€â”€â”€â”€â”€â”€    â”€â”€â”€â”€â”€â”€                                      â”‚
â”‚   0.0s    2000      0           OK                                          â”‚
â”‚   0.1s    2000      500         Take 500 â†’ 1500 remaining                  â”‚
â”‚   0.2s    1500      800         Take 800 â†’ 700 remaining                   â”‚
â”‚   0.3s    700       1000        Take 700 â†’ 0 remaining, REJECT 300         â”‚
â”‚   1.0s    2000      0           Refilled!                                   â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Redis Implementation

```lua
-- Token Bucket Lua Script
local key = KEYS[1]                    -- rate_limit:flash:{sessionId}
local capacity = tonumber(ARGV[1])     -- 2000
local refill_rate = tonumber(ARGV[2])  -- 2000 tokens/second
local now = tonumber(ARGV[3])          -- Current timestamp (ms)
local requested = tonumber(ARGV[4])    -- 1 (tokens needed)

-- Láº¥y state hiá»‡n táº¡i
local data = redis.call('HMGET', key, 'tokens', 'last_refill')
local tokens = tonumber(data[1]) or capacity
local last_refill = tonumber(data[2]) or now

-- TÃ­nh tokens má»›i (refill)
local elapsed = (now - last_refill) / 1000  -- seconds
local new_tokens = math.min(capacity, tokens + (elapsed * refill_rate))

-- Check vÃ  consume
if new_tokens >= requested then
    new_tokens = new_tokens - requested
    redis.call('HMSET', key, 'tokens', new_tokens, 'last_refill', now)
    redis.call('EXPIRE', key, 60)  -- TTL 1 phÃºt
    return 1  -- ALLOWED
else
    return 0  -- REJECTED
end
```

---

## Layer 2: Per-User Purchase Limit

### Váº¥n Ä‘á»: Scalper/Bot Attack

Náº¿u khÃ´ng giá»›i háº¡n má»—i user, má»™t bot cÃ³ thá»ƒ:
- Táº¡o 1000 accounts
- Mua háº¿t 100 sáº£n pháº©m flash sale
- BÃ¡n láº¡i giÃ¡ cao (scalping)

### Giáº£i phÃ¡p: Sliding Window Counter

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     PER-USER LIMIT: 2 ITEMS/SESSION                         â”‚
â”‚                                                                              â”‚
â”‚   Redis Key: flash_user:{sessionId}:{productId}:{userId}                   â”‚
â”‚   Value: Sá»‘ lÆ°á»£ng Ä‘Ã£ mua                                                    â”‚
â”‚   TTL: Háº¿t khi session káº¿t thÃºc                                            â”‚
â”‚                                                                              â”‚
â”‚   FLOW:                                                                      â”‚
â”‚   â•â•â•â•â•                                                                      â”‚
â”‚                                                                              â”‚
â”‚   User A requests 2 items:                                                  â”‚
â”‚   â”œâ”€ GET flash_user:session1:prod1:userA â†’ NULL (chÆ°a mua)                â”‚
â”‚   â”œâ”€ CHECK: 0 + 2 <= 2? âœ“                                                  â”‚
â”‚   â”œâ”€ INCRBY flash_user:session1:prod1:userA 2                             â”‚
â”‚   â””â”€ RESULT: ALLOWED                                                        â”‚
â”‚                                                                              â”‚
â”‚   User A requests 1 more item:                                              â”‚
â”‚   â”œâ”€ GET flash_user:session1:prod1:userA â†’ "2"                            â”‚
â”‚   â”œâ”€ CHECK: 2 + 1 <= 2? âœ—                                                  â”‚
â”‚   â””â”€ RESULT: REJECTED (Ä‘Ã£ mua Ä‘á»§ 2)                                        â”‚
â”‚                                                                              â”‚
â”‚   User B requests 3 items:                                                  â”‚
â”‚   â”œâ”€ GET flash_user:session1:prod1:userB â†’ NULL                           â”‚
â”‚   â”œâ”€ CHECK: 0 + 3 <= 2? âœ—                                                  â”‚
â”‚   â””â”€ RESULT: PARTIAL - Chá»‰ cho phÃ©p mua 2, tá»« chá»‘i 1                      â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Layer 3: Kafka Partition for FIFO Ordering

### Váº¥n Ä‘á»: Request Order Guarantee

Khi 3 users click cÃ¹ng lÃºc, ai Ä‘Æ°á»£c Æ°u tiÃªn?

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    WITHOUT PARTITIONING                                      â”‚
â”‚                                                                              â”‚
â”‚   T=0ms: User A clicks â”€â”€â”€â”€â”€â”                                               â”‚
â”‚   T=1ms: User B clicks â”€â”€â”€â”€â”€â”¼â”€â”€â”€â–¶ [Kafka Topic] â”€â”€â”€â–¶ Consumer 1 â†’ User C   â”‚
â”‚   T=2ms: User C clicks â”€â”€â”€â”€â”€â”˜     (Random order)     Consumer 2 â†’ User A   â”‚
â”‚                                                       Consumer 3 â†’ User B   â”‚
â”‚                                                                              â”‚
â”‚   Káº¿t quáº£: User C (click sau) nhÆ°ng Ä‘Æ°á»£c xá»­ lÃ½ trÆ°á»›c!                      â”‚
â”‚            â†’ KhÃ´ng cÃ´ng báº±ng!                                               â”‚
â”‚                                                                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                    WITH PRODUCT-BASED PARTITIONING                          â”‚
â”‚                                                                              â”‚
â”‚   T=0ms: User A (product1) â”€â”€â”€â–¶ Partition 1 â”€â”€â”€â–¶ FIFO Order                â”‚
â”‚   T=1ms: User B (product1) â”€â”€â”€â–¶ Partition 1 â”€â”€â”€â–¶                           â”‚
â”‚   T=2ms: User C (product1) â”€â”€â”€â–¶ Partition 1 â”€â”€â”€â–¶                           â”‚
â”‚                                                                              â”‚
â”‚   T=0ms: User D (product2) â”€â”€â”€â–¶ Partition 2 â”€â”€â”€â–¶ Xá»­ lÃ½ song song          â”‚
â”‚   T=1ms: User E (product2) â”€â”€â”€â–¶ Partition 2 â”€â”€â”€â–¶                           â”‚
â”‚                                                                              â”‚
â”‚   Káº¿t quáº£:                                                                  â”‚
â”‚   - CÃ¹ng product â†’ CÃ¹ng partition â†’ Xá»­ lÃ½ theo thá»© tá»± click               â”‚
â”‚   - KhÃ¡c product â†’ KhÃ¡c partition â†’ Xá»­ lÃ½ song song (khÃ´ng cáº¡nh tranh)    â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Implementation

```java
// Khi publish event, dÃ¹ng productId lÃ m partition key
kafkaTemplate.send(
    "flash-sale-orders",    // topic
    productId,              // key â†’ Kafka hash Ä‘á»ƒ chá»n partition
    orderEvent              // value
);

// Kafka tá»± Ä‘á»™ng Ä‘áº£m báº£o:
// - CÃ¹ng key â†’ CÃ¹ng partition â†’ CÃ¹ng consumer â†’ FIFO order
```

---

## Layer 4: Separate Flash Stock

### Táº¡i sao cáº§n tÃ¡ch riÃªng?

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    SHARED STOCK PROBLEM                                      â”‚
â”‚                                                                              â”‚
â”‚   Regular Stock: 1000                                                        â”‚
â”‚   Flash Sale: BÃ¡n 100 items vá»›i giÃ¡ giáº£m 50%                               â”‚
â”‚                                                                              â”‚
â”‚   SCENARIO 1: Flash sale success                                            â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                         â”‚
â”‚   - 100 items sold at 50% off                                               â”‚
â”‚   - Remaining: 900 regular stock                                            â”‚
â”‚   âœ“ OK                                                                       â”‚
â”‚                                                                              â”‚
â”‚   SCENARIO 2: Flash sale + Regular sale conflict                           â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                           â”‚
â”‚   - Flash sale: 100 requests for 100 items                                 â”‚
â”‚   - Regular checkout: 50 requests for 100 items                            â”‚
â”‚   - Race condition: Regular buyers "steal" flash stock!                    â”‚
â”‚   âœ— Flash sale customers angry                                              â”‚
â”‚                                                                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                    SEPARATE STOCK SOLUTION                                   â”‚
â”‚                                                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚   â”‚    REGULAR STOCK        â”‚    â”‚    FLASH STOCK          â”‚               â”‚
â”‚   â”‚    stock:prod:size      â”‚    â”‚    flash_stock:session: â”‚               â”‚
â”‚   â”‚         = 900           â”‚    â”‚    product = 100        â”‚               â”‚
â”‚   â”‚                         â”‚    â”‚                         â”‚               â”‚
â”‚   â”‚  â†‘ Regular checkout     â”‚    â”‚  â†‘ Flash sale checkout  â”‚               â”‚
â”‚   â”‚  uses this stock        â”‚    â”‚  uses this stock        â”‚               â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                                                                              â”‚
â”‚   Khi flash sale káº¿t thÃºc:                                                  â”‚
â”‚   - Unsold flash stock â†’ Tráº£ vá» regular stock                              â”‚
â”‚   - flash_stock: 30 remaining â†’ regular stock += 30                        â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Complete Flash Sale Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    COMPLETE FLASH SALE FLOW                                  â”‚
â”‚                                                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                               â”‚
â”‚   â”‚  User   â”‚â”€â”€â”€â”€ Click "Mua Flash Sale" â”€â”€â”€â–¶                              â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                               â”‚
â”‚        â”‚                                                                    â”‚
â”‚        â–¼                                                                    â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚   â”‚  LAYER 1: Rate Limiter                                          â”‚      â”‚
â”‚   â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                         â”‚      â”‚
â”‚   â”‚  IF tokens available:                                            â”‚      â”‚
â”‚   â”‚     consume 1 token â†’ CONTINUE                                   â”‚      â”‚
â”‚   â”‚  ELSE:                                                           â”‚      â”‚
â”‚   â”‚     RETURN 429 "Too Many Requests"                              â”‚      â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚        â”‚                                                                    â”‚
â”‚        â–¼                                                                    â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚   â”‚  LAYER 2: User Limit Check                                       â”‚      â”‚
â”‚   â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                       â”‚      â”‚
â”‚   â”‚  current = GET flash_user:{session}:{product}:{user}            â”‚      â”‚
â”‚   â”‚  IF current + quantity > limit:                                  â”‚      â”‚
â”‚   â”‚     RETURN 400 "Exceeded purchase limit"                        â”‚      â”‚
â”‚   â”‚  ELSE:                                                           â”‚      â”‚
â”‚   â”‚     CONTINUE                                                     â”‚      â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚        â”‚                                                                    â”‚
â”‚        â–¼                                                                    â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚   â”‚  LAYER 3: Atomic Reserve (Lua Script)                           â”‚      â”‚
â”‚   â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                           â”‚      â”‚
â”‚   â”‚  1. CHECK flash_stock >= quantity                               â”‚      â”‚
â”‚   â”‚  2. DECRBY flash_stock                                          â”‚      â”‚
â”‚   â”‚  3. INCRBY user purchase count                                  â”‚      â”‚
â”‚   â”‚  4. SETEX reserve key                                           â”‚      â”‚
â”‚   â”‚                                                                  â”‚      â”‚
â”‚   â”‚  IF success:                                                     â”‚      â”‚
â”‚   â”‚     RETURN orderId                                               â”‚      â”‚
â”‚   â”‚  ELSE:                                                           â”‚      â”‚
â”‚   â”‚     RETURN 400 "Out of stock"                                   â”‚      â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚        â”‚                                                                    â”‚
â”‚        â–¼                                                                    â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚   â”‚  LAYER 4: Kafka Publish (Background Processing)                 â”‚      â”‚
â”‚   â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                    â”‚      â”‚
â”‚   â”‚  kafkaTemplate.send(topic, productId, orderEvent)               â”‚      â”‚
â”‚   â”‚  â†’ Same product â†’ Same partition â†’ FIFO                         â”‚      â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚        â”‚                                                                    â”‚
â”‚        â–¼                                                                    â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚   â”‚  RESPONSE TO USER: 202 Accepted                                  â”‚      â”‚
â”‚   â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                â”‚      â”‚
â”‚   â”‚  {                                                               â”‚      â”‚
â”‚   â”‚    "orderId": "abc123",                                          â”‚      â”‚
â”‚   â”‚    "status": "RESERVED",                                         â”‚      â”‚
â”‚   â”‚    "message": "ÄÆ¡n hÃ ng Ä‘ang Ä‘Æ°á»£c xá»­ lÃ½"                        â”‚      â”‚
â”‚   â”‚  }                                                               â”‚      â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Files sáº½ thay Ä‘á»•i

### Stock Service

| File | Action | MÃ´ táº£ |
|------|--------|-------|
| [NEW] `FlashSaleOptimizedService.java` | Táº¡o má»›i | Service tá»‘i Æ°u cho flash sale |
| [NEW] `RateLimiterService.java` | Táº¡o má»›i | Token bucket rate limiter |
| [MODIFY] `FlashSaleService.java` | Sá»­a | ThÃªm warmup vÃ  cleanup logic |
| [MODIFY] `FlashSaleController.java` | Sá»­a | ThÃªm endpoint cho flash checkout |
| [NEW] `flash_sale_reserve.lua` | Táº¡o má»›i | Lua script cho atomic reserve |

### Order Service

| File | Action | MÃ´ táº£ |
|------|--------|-------|
| [MODIFY] `KafkaConfig.java` | Sá»­a | ThÃªm topic cho flash sale |
| [NEW] `FlashSaleOrderController.java` | Táº¡o má»›i | Endpoint riÃªng cho flash sale |

---

## Verification Plan

### Automated Tests

```bash
# 1. Unit tests
./mvnw test -Dtest=StockReservationServiceTest
./mvnw test -Dtest=FlashSaleOptimizedServiceTest

# 2. Load test vá»›i Locust/k6
k6 run --vus 1000 --duration 60s flash_sale_load_test.js
```

### Manual Verification

1. **Deploy to staging**
2. **Create test flash sale session** vá»›i 100 items
3. **Simulate 1000 concurrent users** vá»›i script
4. **Verify:**
   - KhÃ´ng oversell (sold <= 100)
   - Rate limiting works (rejects > 2000/s)
   - User limit works (max 2/user)
   - Response time < 100ms (P99)

---

## Timeline Æ°á»›c tÃ­nh

| Phase | Task | Duration |
|-------|------|----------|
| 3.1 | `StockReservationService` + Lua scripts | 2 hours |
| 3.2 | Modify `OrderServiceImpl` | 1 hour |
| 3.3 | Cleanup job + Testing | 1 hour |
| 4.1 | Rate Limiter service | 1 hour |
| 4.2 | Flash Sale optimization | 2 hours |
| 4.3 | Integration testing | 2 hours |
| **Total** | | **~9 hours** |
